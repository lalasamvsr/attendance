<!DOCTYPE html>
<html>
<head>
<title>Student Attendance Report</title>
<style>
body{font-family:Arial;background:#f4f6f8;}
.container{width:800px;margin:40px auto;background:#fff;padding:20px;border-radius:8px;}
select{padding:8px;margin-right:10px;margin-bottom:10px;}
table{border-collapse:collapse;width:100%;margin-top:20px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}
th{background:#eef2ff;}
</style>
</head>

<body>
<div class="container">
<h3>Student Attendance History</h3>

<!-- Section -->
<label>Section:</label>
<select id="sectionSelect" onchange="loadStudents()">
<option value="">Select Section</option>
{% for s in sections %}
<option value="{{ s[0] }}">{{ s[1] }}</option>
{% endfor %}
</select>

<!-- Student -->
<label>Student:</label>
<select id="studentSelect" onchange="loadAttendance()">
<option value="">Select Student</option>
</select>

<br><br>

<!-- Datw -->
<label>Date:</label>
<input type="date" id="dateSelect" onchange="loadAttendance()">


<!-- Subject -->
<label>Subject:</label>
<select id="subjectSelect" onchange="loadAttendance()">
<option value="All">All</option>
</select>

<table id="reportTable">
<tr>
<th>Date</th>
<th>Subject</th>
<th>Status</th>
</tr>
</table>
<br>

<button onclick="downloadExcel()" style="padding:8px;">
    â¬‡ Download as Excel
</button>

</div>

<script>
/* Load students based on section */
function loadStudents(){
    const sectionId = document.getElementById("sectionSelect").value;
    const studentSelect = document.getElementById("studentSelect");
    studentSelect.innerHTML = "<option value=''>Select Student</option>";

    if(!sectionId) return;

    fetch(`/get-students/${sectionId}`)
    .then(res => res.json())
    .then(data => {
        data.students.forEach(s => {
            studentSelect.innerHTML +=
              `<option value="${s.id}">${s.roll} - ${s.name}</option>`;
        });
    });
}

/* Load attendance based on student + date */
function loadAttendance(){
    const studentId = document.getElementById("studentSelect").value;
    const selectedDate = document.getElementById("dateSelect").value;
    const table = document.getElementById("reportTable");

    table.innerHTML = `
        <tr>
            <th>Period</th>
            <th>Subject</th>
            <th>Faculty</th>
            <th>Status</th>
        </tr>`;

    if(!studentId || !selectedDate) return;

    fetch(`/get-student-attendance/${studentId}?date=${selectedDate}`)
    .then(res => res.json())
    .then(data => {
        data.attendance.forEach(a => {
            table.innerHTML += `
                <tr>
                    <td>${a.period}</td>
                    <td>${a.subject}</td>
                    <td>${a.faculty}</td>
                    <td>${a.status}</td>
                </tr>`;
        });
    });
}

/* Download Excel */
function downloadExcel(){
    const studentId = document.getElementById("studentSelect").value;
    const selectedDate = document.getElementById("dateSelect").value;

    if(!studentId || !selectedDate){
        alert("Please select student and date");
        return;
    }

    window.location.href = 
        `/download-student-excel?student_id=${studentId}&date=${selectedDate}`;
}
</script>


</body>
</html>


